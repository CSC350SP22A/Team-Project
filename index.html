<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Homepage</title>
    <script src="script.js"></script>
  </head>
  <body>
    <header>
      <nav>
        <a href="index.html">Homepage</a>
      </nav>
      <nav>
        <a href="signup.html">Signup</a>
        <a href="login.html">Login</a>
        <a href="logout.html">Logout</a>
      </nav>
      <script>
        (async () => {
          const user = await getCurrentUser();

          if (user != null) {
            document
              .querySelector("[href='signup.html']")
              .classList.add("hidden");
            document
              .querySelector("[href='login.html']")
              .classList.add("hidden");
          } else {
            document
              .querySelector("[href='logout.html']")
              .classList.add("hidden");
          }
        })();
      </script>
    </header>
    <main>
      <div class="error"></div>
      <div class="message"></div>
      <div id="schedule"></div>
      <script>
        renderSchedule();

        async function renderSchedule() {
          // Delete everything in the schedule div
          document.querySelector("#schedule").innerHTML = "";

          document.querySelector("#schedule").append(new Date());

          const start = new Date();
          start.setHours(0, 0, 0, 0);

          const end = new Date();
          end.setHours(23, 59, 59, 0);

          const params = new URLSearchParams();
          params.set("rangeStart", dateToMysqlFormat(start));
          params.set("rangeEnd", dateToMysqlFormat(end));

          const response = await fetch(
            `api/get-reservations.php?${params.toString()}`,
            {
              method: "GET",
              credentials: "include",
            }
          );

          const reservations = await response.json();
          console.log(reservations);

          for (let i = 0; i < 8; i++) {
            const start = new Date();
            start.setHours(i * 3, 0, 0, 0);

            const end = new Date();
            end.setHours(i * 3 + 3, 0, 0, 0);

            // NOTE: This works for 1-11
            let startHour = start.getHours() % 12;
            let endHour = end.getHours() % 12;
            let startSuffix = "AM";
            let endSuffix = "AM";

            if (start.getHours() >= 12) {
              startSuffix = "PM";
            }

            if (end.getHours() >= 12) {
              endSuffix = "PM";
            }

            // Fix it for 0 or 12
            if (startHour == 0) {
              startHour = 12;
            }

            // Fix it for 0 or 12
            if (endHour == 0) {
              endHour = 12;
            }

            const button = newElement(
              `<button>${startHour}${startSuffix} - ${endHour}${endSuffix}</button>`
            );
            button.onclick = async () => {
              document.querySelector(".error").innerHTML = "";
              document.querySelector(".message").innerHTML = "";

              const response = await fetch(`api/reserve-time.php`, {
                method: "POST",
                body: JSON.stringify({
                  start: dateToMysqlFormat(start),
                  end: dateToMysqlFormat(end),
                }),
                credentials: "include",
              });

              if (!response.ok) {
                const data = await response.json();
                document.querySelector(".error").innerHTML = data.message;
              } else {
                renderSchedule();

                const data = await response.json();
                document.querySelector(".message").innerHTML = data.message;
              }
            };

            if (isRangeReserved(start, end, reservations)) {
              button.disabled = true;
            }

            document.querySelector("#schedule").append(button);
          }
        }

        function isRangeReserved(start, end, reservations) {
          // TODO:
          // For each reservation...
          // If 'start' is between the reservation's range, return true
          // If 'end' is between the reservation's range, return true
          // If 'start' is before the reservation AND 'end' is after, return true

          // range                 v              v
          // reservation              3AM    6AM

          for (const reservation of reservations) {
            // If 'start' is in the range
            if (
              start.getTime() >= new Date(reservation.start).getTime() &&
              start.getTime() < new Date(reservation.end).getTime()
            ) {
              return true;
            }

            // If 'end' is in the range
            if (
              end.getTime() > new Date(reservation.start).getTime() &&
              end.getTime() <= new Date(reservation.end).getTime()
            ) {
              return true;
            }

            // If the range contains the reservation
            if (
              start.getTime() <= new Date(reservation.start).getTime() &&
              end.getTime() >= new Date(reservation.end).getTime()
            ) {
              return true;
            }
          }

          return false;
        }
      </script>
    </main>
    <footer></footer>
  </body>
</html>
